$(function(){
    'use strict';

    $(function(){

        $('.site__header').each( function() {
            new Menu( $(this) );
        } );

        $('.clients').each( function() {
            new Clients( $(this) );
        } );

        $('.main').each( function() {
            new Main( $(this) );
        } );

        $('.project__slider').each( function() {
            new ProjectSlider( $(this) );
        } );

        $('.form-validation').each( function() {
            new FormValidation( $(this) );
        } );

        $('.all-works').each( function() {
            new AllWorks( $(this) );
        } );

        $('.filter').each( function() {
            new Filter( $(this) );
        } );

    });

    var Menu = function( obj ) {

        //private properties
        var _obj = obj,
            _btns= $('.menu__close, .menu-btn'),
            _scrollAdded = false;

        //private methods
        var _addEvents = function () {
                $(window).on( {
                    'resize': function() {
                        _canAddScroll();
                    }
                } );

                _btns.on( {
                    click: function() {
                        _obj.toggleClass( 'open' );
                        _btns.toggleClass( 'open' );
                    }
                } );

            },
            _addScroll = function() {
                _obj.niceScroll({
                    cursorcolor: "#fff",
                    railalign: 'right',
                    cursorwidth: 3,
                    cursorborder: 0,
                    autohidemode: false,
                    railpadding: {top: 0, right: 0, left: 0, bottom: 0}
                });
            },
            _canAddScroll = function() {
                if ( _scrollAdded ) {
                    if ( $( window ).width() > 1023 ) {
                        _obj.getNiceScroll().resize();
                    } else {
                        _obj.getNiceScroll().remove();
                        _obj.removeClass( 'site__header_nice-scroll' );
                        _scrollAdded = false;
                    }
                } else {
                    if ( $( window ).width() > 1023 ) {
                        _addScroll();
                        _obj.addClass( 'site__header_nice-scroll' );
                        _scrollAdded = true;
                    }
                }
            },
            _init = function () {
                _addEvents();
                _canAddScroll();
            };

        _init();
    };

    var Main = function(obj) {

        //private properties
        var _obj = obj,
            _nextBtn = obj.find( '.main__slider-next' ),
            _prevBtn = obj.find( '.main__slider-prev' ),
            _mainSliderWrap = _obj.find('.main__slider'),
            _mainSlider = null,
            _perView = 1,
            _paginationClients = obj.find( '.main__clients-pagination' ),
            _mainSliderClientsWrap = _obj.find('.main__clients'),
            _mainSliderClients = null,
            _duration = 5000,
            _perViewClients = 1;

        //private methods
        var _addEvents = function() {


            },
            _addMainSlider = function() {

                _mainSlider = new Swiper( _mainSliderWrap.find( '.swiper-container' ), {
                    nextButton: _nextBtn,
                    prevButton: _prevBtn,
                    slidesPerView: _perView,
                    loop: true
                });
            },
            _addMainSliderClients = function() {

                _mainSliderClients = new Swiper( _mainSliderClientsWrap.find( '.swiper-container' ), {
                    pagination: _paginationClients,
                    slidesPerView: _perViewClients,
                    loop: true,
                    autoplay: _duration,
                    paginationClickable: true
                });
            },
            _init = function() {
                _addEvents();
                _addMainSlider();
                _addMainSliderClients();
            };

        //public properties

        //public methods

        _init();
    };

    var Clients = function(obj) {

        //private properties
        var _obj = obj,
            _list = _obj.find( '.clients__list' ),
            _items = _obj.find( '.clients__item').length,
            _window = $( window );

        console.log(parseInt(_items/4));

        //private methods
        var _addEvents = function() {

                _window.on( {
                    'resize': function() {
                        _addItems(_window.width());
                    }
                } );

            },
            _addItems = function(mediaScreen) {

                switch (mediaScreen) {
                    case 1024:
                        console.log('1024');
                        break;
                    case 1024:
                        console.log('1366');
                        break;
                    case 1024:
                        console.log('1920');
                        break;
                }

            },
            _init = function() {
                _addEvents();
            };

        //public properties

        //public methods

        _init();
    };

    var ProjectSlider = function(obj) {

        //private properties
        var _obj = obj,
            _nextBtn = obj.find( '.project__slider-next' ),
            _prevBtn = obj.find( '.project__slider-prev' ),
            _mainSlider = null,
            _perView = 1;

        //private methods
        var _addEvents = function() {


            },
            _addSlider = function() {

                _mainSlider = new Swiper( _obj.find( '.swiper-container' ), {
                    nextButton: _nextBtn,
                    prevButton: _prevBtn,
                    slidesPerView: _perView,
                    loop: true
                });
            },
            _init = function() {
                _addEvents();
                _addSlider();
            };

        //public properties

        //public methods

        _init();
    };

    var FormValidation = function( obj ) {

        var _self = this,
            _obj = obj,
            _path = _obj.attr( 'action' ),
            _inputs = _obj.find( '[required]' ),
            _sentMessageMark = _obj.find( '.site__form-sent' ),
            _request = new XMLHttpRequest();

        var _addEvents = function() {

                _obj.on({

                    'submit': function(){

                        $.each( _inputs, function(){

                            var curItem = $( this ),
                                curAttr = curItem.attr( 'type' );

                            if ( curItem.val() == '' ) {
                                curItem.parent().addClass( 'form-validation__error' );
                            }

                            if ( curAttr == 'email' ){
                                var pattern = /^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;
                                if ( pattern.test( curItem.val() ) == false ){
                                    curItem.parent().addClass( 'form-validation__error' );
                                }
                            }

                        } );

                        if ( _obj.find( '.form-validation__error' ).length ) {
                            return false;
                        } else {
                            _ajaxRequest();
                        }

                        return false;

                    }

                });

                _inputs.on({

                    'focus': function() {

                        var curItem = $( this );

                        if( curItem.parent().hasClass( 'form-validation__error' ) ) {
                            curItem.parent().removeClass( 'form-validation__error' );
                        }

                    }

                });

            },
            _ajaxRequest = function() {

                _request.abort();
                _request = $.ajax({
                    url: _path,
                    data: _obj.serialize(),
                    dataType: 'html',
                    timeout: 20000,
                    type: "get",
                    success: function () {

                        //_obj.trigger( 'reset' );

                        if ( _sentMessageMark.length ) {
                            _sentMessageMark.addClass( 'site__form-sent_show' );

                        }

                    },
                    error: function ( XMLHttpRequest ) {
                        if( XMLHttpRequest.statusText != "abort" ) {
                            alert( 'Error!' );
                        }
                    }
                });

            },
            _init = function () {
                _addEvents();
                _obj[ 0 ].obj = _self;
            };

        _init();

    };

    var AllWorks = function ( obj ) {

        var _self = this,
            _obj = obj,
            _siteTitle = _obj.find( '.site__title' ),
            _titlePosTop = _siteTitle.offset().top,
            _titleHeight = _siteTitle.innerHeight(),
            _titleHeightIndent = 0,
            _filter = _obj.find( '.filter' ),
            _filterItem = _obj.find( 'input' ),
            _filterPosTop = _filter.offset().top,
            _filterHeight = _filter.innerHeight(),
            _filterHeightIndent = 0,
            _window = $( window ),
            _scrollTop = _window.scrollTop(),
            _canAddProjects = true,
            _worksWrap = _obj.find('.all-works__wrap'),
            _loader = _obj.find( '.all-works__loader' );

        var _addEvents = function () {

                _window.on({
                    'load': function(){
                        _titlePosTop = _siteTitle.offset().top;
                        _filterPosTop = _filter.offset().top;
                        _calculateValues();
                    },
                    'scroll': function(){
                        _calculateValues();
                        if ( (_scrollTop + _window.height() ) > (_worksWrap.offset().top + _worksWrap.height()) ) {
                            if ( _canAddProjects ) {
                                _canAddProjects = false;
                                _sendAjax();
                                _loader.addClass('active');
                            }
                        }
                    },
                    'resize': function(){
                        _titlePosTop = _siteTitle.offset().top;
                        _filterPosTop = _filter.offset().top;
                        _calculateValues();
                    }
                });

                _filterItem.on( {
                    'change': function() {
                        $('.all-works__item').remove();
                        _sendAjax();
                        _loader.addClass('active');
                    }
                } );

            },
            _addPadding = function()  {

                var paddingTop;

                if ( _siteTitle.hasClass( 'fixed' ) ){
                    _titleHeightIndent = _siteTitle.innerHeight() + parseInt( _siteTitle.css( 'margin-bottom' ) );
                } else {
                    _titleHeightIndent = 0;
                }

                if ( _filter.hasClass( 'fixed' ) ){
                    _filterHeightIndent = _filter.innerHeight() + parseInt( _filter.css( 'margin-bottom' ) );
                } else {
                    _filterHeightIndent = 0;
                }

                paddingTop = _titleHeightIndent + _filterHeightIndent;

                _obj.css( {
                    'padding-top': paddingTop
                } );

            },
            _addItems = function( arr ) {

                setTimeout( function() {
                    _loader.removeClass('active');

                    for ( var i =0; i < arr.length; i++ ) {
                        _worksWrap.append('<div class="all-works__item">' +
                            '<a href="' + arr[i].link + '" class="all-works__pic" style="background-image: url(' + arr[i].pic + ')"></a>' +
                            '<div class="all-works__footer">' +
                            '<span class="all-works__name">' + arr[i].name + '</span>' +
                            '<span class="all-works__icon">' + arr[i].icon + '</span>' +
                            '<span class="all-works__square">' + arr[i].square + '<span>m<span>2</span></span></span>' +
                            '<a href="' + arr[i].link + '" class="btn btn_2"></a>' +
                            '</div></div>');
                    }
                }, 500 );

            },
            _calculateValues = function() {
                _titleHeight = _siteTitle.innerHeight();
                _filterHeight = _filter.innerHeight();
                _scrollTop = _window.scrollTop();
                _filterFixed();
                _titleFixed();
                _addPadding();
            },
            _filterFixed = function() {

                if ( _scrollTop >= _filterPosTop - _titleHeight ){
                    _filter.addClass( 'fixed' );
                    _filter.css( {
                        top: _titleHeight
                    } );
                } else {
                    _filter.removeClass( 'fixed' );
                    _filter.css( {
                        top: ''
                    } );
                }

            },
            _sendAjax = function() {

                $.ajax({
                    url: $('body').data('action'),
                    data: {
                        action : "get_posts",
                        filterData: $( '.filter' ).serialize()
                    },
                    dataType: 'json',
                    type: "get",
                    success: function (msg) {
                        _addItems(msg.items);
                        if ( msg.col > 0 ) {
                            _canAddProjects = true;
                        }
                    },
                    error: function (XMLHttpRequest) {
                        if (XMLHttpRequest.statusText != "abort") {
                            alert("ERROR!!!");
                        }
                    }
                });

            },
            _titleFixed = function() {

                if ( _scrollTop > _titlePosTop ){
                    _siteTitle.addClass( 'fixed' );
                } else {
                    _siteTitle.removeClass( 'fixed' );
                }

            },
            _init = function () {
                _calculateValues();
                _addEvents();
                _obj[0].obj = _self;
            };

        _init();

    };

    var Filter = function( obj ) {

        var _self = this,
            _obj = obj,
            _item = _obj.find( 'input' );

        var _addEvents = function() {

                _item.on( {
                    change: function() {
                        //_obj.submit();
                    }
                } );

            },
            _init = function() {
                _addEvents();
                _obj[0].obj = _self;
            };

        _init();

    };

});
